<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Chat</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
</head>

<body>

    <div id="app" class="container mt-5">

        <h2>Simple Chat</h2>
        <div class="row">
            <div class="col">
                <table class="table table-dark table-striped table-hover">
                    <thead>
                        <th>Message</th>
                        <th>Time</th>
                    </thead>
                    <tbody id="chat-data"></tbody>
                </table>
            </div>
            <div class="col">
                <form id="chat-form">
                    <div class="mb-3">
                        <input type="text" id="chat-input" placeholder="Type your message here..." class="form-control">
                    </div>
                    <button type="submit" class="btn btn-primary">Send</button>
                </form>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
        crossorigin="anonymous"></script>

    <script type="module">
        import { FIREBASE_CONFIG } from './config.js';

        //we are running the code in module mode
        //this taps on the CDN version of the firebase SDK
        //for firebase app
        import {
            //determine which services you want to use
            initializeApp
        } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js';

        //for realtime database
        import {
            //determine which services you want to use
            getDatabase, ref, set, get, onValue, push, child, update, remove,
        } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js';

        //for auth
        import {
            //determine which services you want to use
            getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut
        } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js';

        const app = initializeApp(FIREBASE_CONFIG);

        //get a reference to the database service
        const db = getDatabase();
        //Working with Auth
        const auth = getAuth();

        const chatRef = ref(db, 'chat');

        let frmChat = document.getElementById('chat-form');
        frmChat.addEventListener('submit', (e) => {
            e.preventDefault();
            sendMessage();
        });

        function sendMessage() {
            const chatInput = document.getElementById('chat-input');
            const chatForm = document.getElementById('chat-form');
            const chatMessage = {
                message: chatInput.value,
                timestamp: Date.now()
            };
            push(chatRef, chatMessage);
            chatInput.value = '';

        }

        //update our chat table with new rows 
        const chatData = document.getElementById("chat-data");
        //take snapshot and loop through data 

        //let's monitor the DAU node for any changes

        onValue(chatRef, (snapshot) => {
            const newData = snapshot.val();

            console.log("data changes:", newData);
            // Handle the new data (e.g., update the UI)

            const chatTableContent = document.getElementById("chat-data");
            if (newData != null) {
                let chatContents = "";
                //loop throught chat messages snapshot and update table data
                snapshot.forEach((childSnapshot) => {
                    //retrieve out each entry value as an object
                    const chatMsgEntry = childSnapshot.val();

                    //we use object notation "." to retrieve
                    const msg = chatMsgEntry.message;
                    const timestamp = chatMsgEntry.timestamp;
                    const date = new Date(timestamp);

                    // Format the date into a readable string
                    const formattedDate = date.toString();
                    console.log(msg)
                    //create a table row consisting of table cells that contain the obj data
                    chatContents += `<tr><td>${msg}</td><td>${formattedDate}</td></tr>`;

                });
                //update our table content placeholder
                chatTableContent.innerHTML = chatContents;
            }
        });

    </script>
</body>

</html>